# yamllint disable rule:document-start
# yamllint disable rule:line-length
# yamllint disable rule:empty-lines
# yamllint disable rule:trailing-spaces
# yamllint disable rule:new-line-at-end-of-file
# yamllint disable rule:indentation

name: Build
on:  # yamllint disable-line rule:truthy
  pull_request:
    paths-ignore:
    - '**.md'
  push:
    paths-ignore:
    - '**.md'

jobs:
  create-release-nim-0-20-2:
    name: Create release 0.20.2
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_name: ${{ steps.generate-release-name.outputs.release_name }}


    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Generate release name
      id: generate-release-name
      run: |
        release_name=nim-0.20.2--$(date '+%Y%m%d%H%M')
        echo "::set-output name=release_name::${release_name}"

    - name: Create release
      id: create-release
      uses: actions/create-release@v1

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.generate-release-name.outputs.release_name }}
        release_name: ${{ steps.generate-release-name.outputs.release_name }}
        draft: true
        prerelease: ${{ !startsWith(github.event.ref, 'refs/tags/') }}






  
  
  build-nim-0-20-2--alpine-3-12--amd64:
    name: Build nim-0.20.2--alpine-3-12--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-alpine-3-12-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-0.20.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--alpine-3-12--amd64.tar.xz
        asset_content_type: application/x-xz


  
  
  build-nim-0-20-2--alpine-3-12--arm32v6:
    name: Build nim-0.20.2--alpine-3-12--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-alpine-3-12-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--alpine-3-12--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  build-nim-0-20-2--alpine-3-12--arm32v7:
    name: Build nim-0.20.2--alpine-3-12--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-alpine-3-12-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--alpine-3-12--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  build-nim-0-20-2--alpine-3-12--arm64v8:
    name: Build nim-0.20.2--alpine-3-12--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-alpine-3-12-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--alpine-3-12--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  
  
  build-nim-0-20-2--archlinux--amd64:
    name: Build nim-0.20.2--archlinux--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-archlinux-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:archlinux \
          sh /scripts/build-nim.sh /build/nim-0.20.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--archlinux--amd64.tar.xz
        asset_content_type: application/x-xz


  
  
  build-nim-0-20-2--archlinux--arm32v5:
    name: Build nim-0.20.2--archlinux--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-archlinux-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--archlinux--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  build-nim-0-20-2--archlinux--arm32v6:
    name: Build nim-0.20.2--archlinux--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-archlinux-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--archlinux--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  build-nim-0-20-2--archlinux--arm32v7:
    name: Build nim-0.20.2--archlinux--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-archlinux-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--archlinux--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  build-nim-0-20-2--archlinux--arm64v8:
    name: Build nim-0.20.2--archlinux--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-archlinux-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--archlinux--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  
  
  
  build-nim-0-20-2--debian-buster--amd64:
    name: Build nim-0.20.2--debian-buster--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--amd64.tar.xz
        asset_content_type: application/x-xz


  
  
  build-nim-0-20-2--debian-buster--386:
    name: Build nim-0.20.2--debian-buster--386.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/386-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--386.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  
  build-nim-0-20-2--debian-buster--arm32v5:
    name: Build nim-0.20.2--debian-buster--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  
  build-nim-0-20-2--debian-buster--arm32v7:
    name: Build nim-0.20.2--debian-buster--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  
  build-nim-0-20-2--debian-buster--arm64v8:
    name: Build nim-0.20.2--debian-buster--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  
  build-nim-0-20-2--debian-buster--ppc64le:
    name: Build nim-0.20.2--debian-buster--ppc64le.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-0.20.2-debian-buster-linux/ppc64le-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-0.20.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-0.20.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-0.20.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-0-20-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-0.20.2--debian-buster--ppc64le.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  
  

  publish-release-nim-0-20-2:
    name: Publish release 0.20.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-0-20-2


    - build-nim-0-20-2--alpine-3-12--amd64

    - build-nim-0-20-2--alpine-3-12--arm32v6

    - build-nim-0-20-2--alpine-3-12--arm32v7

    - build-nim-0-20-2--alpine-3-12--arm64v8



    - build-nim-0-20-2--archlinux--amd64

    - build-nim-0-20-2--archlinux--arm32v5

    - build-nim-0-20-2--archlinux--arm32v6

    - build-nim-0-20-2--archlinux--arm32v7

    - build-nim-0-20-2--archlinux--arm64v8



    - build-nim-0-20-2--debian-buster--amd64

    - build-nim-0-20-2--debian-buster--386

    - build-nim-0-20-2--debian-buster--arm32v5

    - build-nim-0-20-2--debian-buster--arm32v7

    - build-nim-0-20-2--debian-buster--arm64v8

    - build-nim-0-20-2--debian-buster--ppc64le



    steps:
    - uses: eregon/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        release_id: ${{ needs.nim-0-20-2-create-release.outputs.id }}


  create-release-nim-1-0-10:
    name: Create release 1.0.10
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_name: ${{ steps.generate-release-name.outputs.release_name }}


    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Generate release name
      id: generate-release-name
      run: |
        release_name=nim-1.0.10--$(date '+%Y%m%d%H%M')
        echo "::set-output name=release_name::${release_name}"

    - name: Create release
      id: create-release
      uses: actions/create-release@v1

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.generate-release-name.outputs.release_name }}
        release_name: ${{ steps.generate-release-name.outputs.release_name }}
        draft: true
        prerelease: ${{ !startsWith(github.event.ref, 'refs/tags/') }}






  
  
  build-nim-1-0-10--alpine-3-12--amd64:
    name: Build nim-1.0.10--alpine-3-12--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.0.10



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--alpine-3-12--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-0-10--alpine-3-12--amd64:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--alpine-3-12--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--alpine-3-12--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.0.10




  build-nim-1-0-10--alpine-3-12--arm32v6:
    name: Build nim-1.0.10--alpine-3-12--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--alpine-3-12--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--alpine-3-12--arm32v6:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--alpine-3-12--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--alpine-3-12--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--alpine-3-12--arm32v7:
    name: Build nim-1.0.10--alpine-3-12--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--alpine-3-12--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--alpine-3-12--arm32v7:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--alpine-3-12--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--alpine-3-12--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--alpine-3-12--arm64v8:
    name: Build nim-1.0.10--alpine-3-12--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--alpine-3-12--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--alpine-3-12--arm64v8:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--alpine-3-12--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-alpine-3-12-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--alpine-3-12--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.0.10






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--archlinux--amd64:
    name: Build nim-1.0.10--archlinux--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.0.10



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--archlinux--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-0-10--archlinux--amd64:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--archlinux--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--archlinux--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.0.10




  build-nim-1-0-10--archlinux--arm32v5:
    name: Build nim-1.0.10--archlinux--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--archlinux--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--archlinux--arm32v5:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--archlinux--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--archlinux--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--archlinux--arm32v6:
    name: Build nim-1.0.10--archlinux--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--archlinux--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--archlinux--arm32v6:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--archlinux--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--archlinux--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--archlinux--arm32v7:
    name: Build nim-1.0.10--archlinux--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--archlinux--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--archlinux--arm32v7:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--archlinux--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--archlinux--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--archlinux--arm64v8:
    name: Build nim-1.0.10--archlinux--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--archlinux--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-0-10--archlinux--arm64v8:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--archlinux--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-archlinux-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--archlinux--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.0.10






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-0-10--debian-buster--amd64:
    name: Build nim-1.0.10--debian-buster--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-0-10--debian-buster--amd64:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10




  build-nim-1-0-10--debian-buster--386:
    name: Build nim-1.0.10--debian-buster--386.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/386-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--386.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-0-10--debian-buster--386:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--386
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/386-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--386.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-0-10--debian-buster--arm32v5:
    name: Build nim-1.0.10--debian-buster--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-0-10--debian-buster--arm32v5:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-0-10--debian-buster--arm32v7:
    name: Build nim-1.0.10--debian-buster--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-0-10--debian-buster--arm32v7:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-0-10--debian-buster--arm64v8:
    name: Build nim-1.0.10--debian-buster--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-0-10--debian-buster--arm64v8:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-0-10--debian-buster--ppc64le:
    name: Build nim-1.0.10--debian-buster--ppc64le.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/ppc64le-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.0.10"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.0.10 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.0.10"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-0-10-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.0.10--debian-buster--ppc64le.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-0-10--debian-buster--ppc64le:
    name: Test 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10
    - build-nim-1-0-10--debian-buster--ppc64le
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.0.10-debian-buster-linux/ppc64le-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-0-10.outputs.release_name
        tarball=nim-1.0.10--debian-buster--ppc64le.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.0.10.tar"
        tar xf "nim-1.0.10.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.0.10





    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  publish-release-nim-1-0-10:
    name: Publish release 1.0.10
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-0-10


    - build-nim-1-0-10--alpine-3-12--amd64

    - build-nim-1-0-10--alpine-3-12--arm32v6

    - build-nim-1-0-10--alpine-3-12--arm32v7

    - build-nim-1-0-10--alpine-3-12--arm64v8



    - build-nim-1-0-10--archlinux--amd64

    - build-nim-1-0-10--archlinux--arm32v5

    - build-nim-1-0-10--archlinux--arm32v6

    - build-nim-1-0-10--archlinux--arm32v7

    - build-nim-1-0-10--archlinux--arm64v8



    - build-nim-1-0-10--debian-buster--amd64

    - build-nim-1-0-10--debian-buster--386

    - build-nim-1-0-10--debian-buster--arm32v5

    - build-nim-1-0-10--debian-buster--arm32v7

    - build-nim-1-0-10--debian-buster--arm64v8

    - build-nim-1-0-10--debian-buster--ppc64le



    steps:
    - uses: eregon/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        release_id: ${{ needs.nim-1-0-10-create-release.outputs.id }}


  create-release-nim-1-2-8:
    name: Create release 1.2.8
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_name: ${{ steps.generate-release-name.outputs.release_name }}


    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Generate release name
      id: generate-release-name
      run: |
        release_name=nim-1.2.8--$(date '+%Y%m%d%H%M')
        echo "::set-output name=release_name::${release_name}"

    - name: Create release
      id: create-release
      uses: actions/create-release@v1

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.generate-release-name.outputs.release_name }}
        release_name: ${{ steps.generate-release-name.outputs.release_name }}
        draft: true
        prerelease: ${{ !startsWith(github.event.ref, 'refs/tags/') }}






  
  
  build-nim-1-2-8--alpine-3-12--amd64:
    name: Build nim-1.2.8--alpine-3-12--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.2.8



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--alpine-3-12--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-2-8--alpine-3-12--amd64:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--alpine-3-12--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--alpine-3-12--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.2.8




  build-nim-1-2-8--alpine-3-12--arm32v6:
    name: Build nim-1.2.8--alpine-3-12--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--alpine-3-12--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--alpine-3-12--arm32v6:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--alpine-3-12--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--alpine-3-12--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--alpine-3-12--arm32v7:
    name: Build nim-1.2.8--alpine-3-12--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--alpine-3-12--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--alpine-3-12--arm32v7:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--alpine-3-12--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--alpine-3-12--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--alpine-3-12--arm64v8:
    name: Build nim-1.2.8--alpine-3-12--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--alpine-3-12--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--alpine-3-12--arm64v8:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--alpine-3-12--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-alpine-3-12-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--alpine-3-12--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.2.8






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--archlinux--amd64:
    name: Build nim-1.2.8--archlinux--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.2.8



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--archlinux--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-2-8--archlinux--amd64:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--archlinux--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--archlinux--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.2.8




  build-nim-1-2-8--archlinux--arm32v5:
    name: Build nim-1.2.8--archlinux--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--archlinux--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--archlinux--arm32v5:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--archlinux--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--archlinux--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--archlinux--arm32v6:
    name: Build nim-1.2.8--archlinux--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--archlinux--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--archlinux--arm32v6:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--archlinux--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--archlinux--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--archlinux--arm32v7:
    name: Build nim-1.2.8--archlinux--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--archlinux--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--archlinux--arm32v7:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--archlinux--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--archlinux--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--archlinux--arm64v8:
    name: Build nim-1.2.8--archlinux--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--archlinux--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-2-8--archlinux--arm64v8:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--archlinux--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-archlinux-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--archlinux--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.2.8






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-2-8--debian-buster--amd64:
    name: Build nim-1.2.8--debian-buster--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-2-8--debian-buster--amd64:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8




  build-nim-1-2-8--debian-buster--386:
    name: Build nim-1.2.8--debian-buster--386.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/386-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--386.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-2-8--debian-buster--386:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--386
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/386-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--386.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-2-8--debian-buster--arm32v5:
    name: Build nim-1.2.8--debian-buster--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-2-8--debian-buster--arm32v5:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-2-8--debian-buster--arm32v7:
    name: Build nim-1.2.8--debian-buster--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-2-8--debian-buster--arm32v7:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-2-8--debian-buster--arm64v8:
    name: Build nim-1.2.8--debian-buster--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-2-8--debian-buster--arm64v8:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-2-8--debian-buster--ppc64le:
    name: Build nim-1.2.8--debian-buster--ppc64le.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/ppc64le-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.2.8"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.2.8 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.2.8"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-2-8-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.2.8--debian-buster--ppc64le.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-2-8--debian-buster--ppc64le:
    name: Test 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8
    - build-nim-1-2-8--debian-buster--ppc64le
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.2.8-debian-buster-linux/ppc64le-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-2-8.outputs.release_name
        tarball=nim-1.2.8--debian-buster--ppc64le.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.2.8.tar"
        tar xf "nim-1.2.8.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.2.8





    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  publish-release-nim-1-2-8:
    name: Publish release 1.2.8
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-2-8


    - build-nim-1-2-8--alpine-3-12--amd64

    - build-nim-1-2-8--alpine-3-12--arm32v6

    - build-nim-1-2-8--alpine-3-12--arm32v7

    - build-nim-1-2-8--alpine-3-12--arm64v8



    - build-nim-1-2-8--archlinux--amd64

    - build-nim-1-2-8--archlinux--arm32v5

    - build-nim-1-2-8--archlinux--arm32v6

    - build-nim-1-2-8--archlinux--arm32v7

    - build-nim-1-2-8--archlinux--arm64v8



    - build-nim-1-2-8--debian-buster--amd64

    - build-nim-1-2-8--debian-buster--386

    - build-nim-1-2-8--debian-buster--arm32v5

    - build-nim-1-2-8--debian-buster--arm32v7

    - build-nim-1-2-8--debian-buster--arm64v8

    - build-nim-1-2-8--debian-buster--ppc64le



    steps:
    - uses: eregon/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        release_id: ${{ needs.nim-1-2-8-create-release.outputs.id }}


  create-release-nim-1-4-2:
    name: Create release 1.4.2
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
      release_name: ${{ steps.generate-release-name.outputs.release_name }}


    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Generate release name
      id: generate-release-name
      run: |
        release_name=nim-1.4.2--$(date '+%Y%m%d%H%M')
        echo "::set-output name=release_name::${release_name}"

    - name: Create release
      id: create-release
      uses: actions/create-release@v1

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.generate-release-name.outputs.release_name }}
        release_name: ${{ steps.generate-release-name.outputs.release_name }}
        draft: true
        prerelease: ${{ !startsWith(github.event.ref, 'refs/tags/') }}






  
  
  build-nim-1-4-2--alpine-3-12--amd64:
    name: Build nim-1.4.2--alpine-3-12--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.4.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--alpine-3-12--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-4-2--alpine-3-12--amd64:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--alpine-3-12--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--alpine-3-12--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.4.2




  build-nim-1-4-2--alpine-3-12--arm32v6:
    name: Build nim-1.4.2--alpine-3-12--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--alpine-3-12--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--alpine-3-12--arm32v6:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--alpine-3-12--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--alpine-3-12--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--alpine-3-12--arm32v7:
    name: Build nim-1.4.2--alpine-3-12--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--alpine-3-12--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--alpine-3-12--arm32v7:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--alpine-3-12--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--alpine-3-12--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--alpine-3-12--arm64v8:
    name: Build nim-1.4.2--alpine-3-12--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--alpine-3-12--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--alpine-3-12--arm64v8:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--alpine-3-12--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:alpine-3.12}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-alpine-3-12-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--alpine-3-12--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:alpine-3.12 \
          sh /scripts/test-nim.sh /build/nim-1.4.2






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:alpine-3.12 --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--archlinux--amd64:
    name: Build nim-1.4.2--archlinux--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.4.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--archlinux--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-4-2--archlinux--amd64:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--archlinux--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--archlinux--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.4.2




  build-nim-1-4-2--archlinux--arm32v5:
    name: Build nim-1.4.2--archlinux--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--archlinux--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--archlinux--arm32v5:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--archlinux--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--archlinux--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--archlinux--arm32v6:
    name: Build nim-1.4.2--archlinux--arm32v6.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v6-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--archlinux--arm32v6.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--archlinux--arm32v6:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--archlinux--arm32v6
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v6-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--archlinux--arm32v6.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v6 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--archlinux--arm32v7:
    name: Build nim-1.4.2--archlinux--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--archlinux--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--archlinux--arm32v7:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--archlinux--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--archlinux--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--archlinux--arm64v8:
    name: Build nim-1.4.2--archlinux--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:archlinux \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--archlinux--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi


  
  test-nim-1-4-2--archlinux--arm64v8:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--archlinux--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:archlinux}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-archlinux-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--archlinux--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:archlinux \
          sh /scripts/test-nim.sh /build/nim-1.4.2






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:archlinux --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi

  build-nim-1-4-2--debian-buster--amd64:
    name: Build nim-1.4.2--debian-buster--amd64.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/amd64-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        # Build in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2



    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--amd64.tar.xz
        asset_content_type: application/x-xz


  
  test-nim-1-4-2--debian-buster--amd64:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--amd64
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/amd64-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--amd64.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in native container
        docker run \
          --platform linux/amd64 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2




  build-nim-1-4-2--debian-buster--386:
    name: Build nim-1.4.2--debian-buster--386.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/386-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--386.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-4-2--debian-buster--386:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--386
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/386-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--386.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/386 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-4-2--debian-buster--arm32v5:
    name: Build nim-1.4.2--debian-buster--arm32v5.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm/v5-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--arm32v5.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-4-2--debian-buster--arm32v5:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--arm32v5
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm/v5-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--arm32v5.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v5 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-4-2--debian-buster--arm32v7:
    name: Build nim-1.4.2--debian-buster--arm32v7.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm/v7-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--arm32v7.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-4-2--debian-buster--arm32v7:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--arm32v7
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm/v7-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--arm32v7.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm/v7 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-4-2--debian-buster--arm64v8:
    name: Build nim-1.4.2--debian-buster--arm64v8.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm64/v8-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--arm64v8.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-4-2--debian-buster--arm64v8:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--arm64v8
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/arm64/v8-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--arm64v8.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/arm64/v8 \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2




    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi



  build-nim-1-4-2--debian-buster--ppc64le:
    name: Build nim-1.4.2--debian-buster--ppc64le.tar.xz
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    strategy:
      fail-fast: false
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Enable Docker experimental features
      run: |
        echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
        sudo service docker restart
        docker version -f '{{.Server.Experimental}}'

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/ppc64le-nimcache

    - name: Setup dirs
      run: |
        mkdir -p build
        mkdir -p nimcache


    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Download Nim source
      run: |
        cd build
        nim_dir="nim-1.4.2"
        wget "https://nim-lang.org/download/${nim_dir}.tar.xz"
        pixz -d "${nim_dir}.tar.xz" "${nim_dir}.tar"
        tar xf "${nim_dir}.tar"
        rm "${nim_dir}.tar.xz" "${nim_dir}.tar"

    - name: Build Nim
      id: build-nim
      shell: bash
      run: |
        set -uexo pipefail


        dump_logs () {
          docker logs $(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        }

        # Build in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          --workdir /build \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/build-nim.sh /build/nim-1.4.2 || (status=$?; dump_logs; exit $status)


    - name: Create tarball
      id: create-tarball
      run: |
        cd build
        nim_dir="nim-1.4.2"
        tarball="${nim_dir}.tar.xz"
        tar -Ipixz -cf "$tarball" "$nim_dir"
        echo "::set-output name=tarball_asset_path::${PWD}/${tarball}"

    - name: Add tarball to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        upload_url: ${{ needs.nim-1-4-2-create-release.outputs.upload_url }}
        asset_path: ${{ steps.create-tarball.outputs.tarball_asset_path }}
        asset_name: nim-1.4.2--debian-buster--ppc64le.tar.xz
        asset_content_type: application/x-xz

    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  
  test-nim-1-4-2--debian-buster--ppc64le:
    name: Test 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2
    - build-nim-1-4-2--debian-buster--ppc64le
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install deps
      run: |
        sudo add-apt-repository ppa:cpick/hub
        sudo apt-get update -q -y
        sudo apt-get -qq install -y hub pixz

    - uses: actions/setup-node@v2
      with:
        node-version: '12'
    - name: Configure QEMU
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Start distcc host
      run: |
        docker run -d \
          --platform linux/amd64 \
          -p 3600-3900:3600-3900/tcp \
          elijahru/build-farm:debian-buster-slim}

    - name: Restore Nim cache
      uses: actions/cache@v2
      with:
        path: |
          build/nimcache
        key: nim-1.4.2-debian-buster-linux/ppc64le-nimcache

    - name: Download released tarball
      run: |
        cd build
        tag=${{ needs.create-release-nim-1-4-2.outputs.release_name
        tarball=nim-1.4.2--debian-buster--ppc64le.tar.xz
        hub release download "$tag" -i "$tarball"
        pixz -d "tarball" "nim-1.4.2.tar"
        tar xf "nim-1.4.2.tar"

    - name: Run tests
      run: |
        mkdir -p nimcache


        # Test in emulated container
        docker run \
          --platform linux/ppc64le \
          --mount "type=bind,src=${PWD}/nimcache,dst=/root/.cache/nim" \
          --mount "type=bind,src=${PWD}/build,dst=/build" \
          --mount "type=bind,src=${PWD}/scripts,dst=/scripts" \
          elijahru/build-farm-client:debian-buster-slim \
          sh /scripts/test-nim.sh /build/nim-1.4.2






    - name: Stop distcc host
      run: |
        id=$(docker ps --filter ancestor=elijahru/build-farm:debian-buster-slim --format "{{.ID}}")
        if [ "$id" != "" ]
        then
          docker kill $id
        fi




  publish-release-nim-1-4-2:
    name: Publish release 1.4.2
    runs-on: ubuntu-latest
    needs:
    - create-release-nim-1-4-2


    - build-nim-1-4-2--alpine-3-12--amd64

    - build-nim-1-4-2--alpine-3-12--arm32v6

    - build-nim-1-4-2--alpine-3-12--arm32v7

    - build-nim-1-4-2--alpine-3-12--arm64v8



    - build-nim-1-4-2--archlinux--amd64

    - build-nim-1-4-2--archlinux--arm32v5

    - build-nim-1-4-2--archlinux--arm32v6

    - build-nim-1-4-2--archlinux--arm32v7

    - build-nim-1-4-2--archlinux--arm64v8



    - build-nim-1-4-2--debian-buster--amd64

    - build-nim-1-4-2--debian-buster--386

    - build-nim-1-4-2--debian-buster--arm32v5

    - build-nim-1-4-2--debian-buster--arm32v7

    - build-nim-1-4-2--debian-buster--arm64v8

    - build-nim-1-4-2--debian-buster--ppc64le



    steps:
    - uses: eregon/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      with:
        release_id: ${{ needs.nim-1-4-2-create-release.outputs.id }}

